<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TENG 圖片處理工具 v1.8</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #F5F8FA;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        h1 {
            color: #0033A0;
            font-size: 24px;
            margin: 0 0 15px;
            font-weight: 500;
        }
        .section {
            background-color: #E6F0FA;
            border: 1px solid #005B99;
            border-radius: 6px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .file-button-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .file-button, .clear-button {
            font-size: 14px;
            padding: 8px 16px;
            cursor: pointer;
            background-color: #E6F0FA;
            border: 1px solid #005B99;
            border-radius: 4px;
            color: #005B99;
            transition: background-color 0.2s, color 0.2s;
        }
        .file-button:hover, .clear-button:hover {
            background-color: #005B99;
            color: #FFFFFF;
        }
        .process-button {
            font-size: 18px;
            padding: 10px 20px;
            cursor: pointer;
            background-color: #E6F0FA;
            border: 1px solid #005B99;
            border-radius: 4px;
            color: #005B99;
            transition: background-color 0.2s, color 0.2s;
        }
        .process-button:hover {
            background-color: #005B99;
            color: #FFFFFF;
        }
        #downloadButton {
            font-size: 16px;
            padding: 10px 20px;
            cursor: pointer;
            background-color: #005B99;
            border: none;
            border-radius: 4px;
            color: #FFFFFF;
            display: none;
            transition: background-color 0.2s;
        }
        #downloadButton:hover {
            background-color: #0033A0;
        }
        #fileList {
            max-height: 120px;
            overflow-y: auto;
            border: 1px solid #005B99;
            border-radius: 4px;
            padding: 10px;
            font-size: 12px;
            background-color: #FFFFFF;
        }
        .file-item {
            margin-bottom: 5px;
        }
        .thumbnail-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .thumbnail {
            max-width: 60px;
            max-height: 60px;
            object-fit: contain;
            border: 1px solid #005B99;
            border-radius: 4px;
        }
        .base64-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        textarea {
            width: 100%;
            height: 100px;
            font-size: 12px;
            border: 1px solid #005B99;
            border-radius: 4px;
            resize: vertical;
            background-color: #FFFFFF;
        }
        .hidden {
            display: none !important;
        }
        .mode-specific {
            display: none;
        }
        .controls div {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        label {
            font-size: 14px;
            color: #0033A0;
            font-weight: 500;
            min-width: 80px;
        }
        input[type="number"] {
            width: 100px;
            padding: 6px;
            font-size: 14px;
            border: 1px solid #005B99;
            border-radius: 4px;
            background-color: #FFFFFF;
        }
        input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        .mode-buttons, .dimension-buttons, .size-buttons, .quality-buttons, .format-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .mode-button, .dimension-button, .size-button, .quality-button, .format-button {
            font-size: 14px;
            padding: 8px 16px;
            cursor: pointer;
            background-color: #E6F0FA;
            border: 1px solid #005B99;
            border-radius: 4px;
            color: #005B99;
            transition: background-color 0.2s, color 0.2s;
        }
        .mode-button.active, .dimension-button.active, .size-button.active, .quality-button.active, .format-button.active {
            background-color: #0033A0;
            color: #FFFFFF;
            border-color: #0033A0;
        }
        .mode-button:hover, .dimension-button:hover, .size-button:hover, .quality-button:hover, .format-button:hover {
            background-color: #005B99;
            color: #FFFFFF;
        }
        .progress-container {
            display: none;
            margin-top: 10px;
        }
        .progress-bar {
            width: 100%;
            height: 16px;
            background-color: #E6F0FA;
            border: 1px solid #005B99;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #005B99;
            width: 0%;
            transition: width 0.3s;
        }
        .progress-text {
            font-size: 12px;
            color: #0033A0;
            text-align: center;
            margin-top: 5px;
        }
        .error-message {
            display: none;
            background-color: #ffe6e6;
            border: 1px solid #ff3333;
            padding: 10px;
            border-radius: 4px;
            color: #ff3333;
            font-size: 12px;
            margin-top: 10px;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #005B99;
            color: #FFFFFF;
            text-align: center;
            border-radius: 4px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TENG 圖片處理工具 v1.8</h1>
        
        <div class="section">
            <label>處理模式</label>
            <div class="mode-buttons">
                <button class="mode-button active" data-mode="resize" onclick="switchMode('resize')">尺寸調整與格式轉換</button>
                <button class="mode-button" data-mode="base64" onclick="switchMode('base64')">Base64 互轉</button>
            </div>
        </div>
        
        <div class="section file-button-container">
            <div>
                <label>圖片檔案</label>
                <button class="file-button" onclick="triggerFileInput('imageInput')">選擇圖片</button>
                <input type="file" id="imageInput" accept="image/*,.heic,.heif" multiple class="hidden">
            </div>
            <div>
                <label>圖片資料夾</label>
                <button class="file-button" onclick="triggerFileInput('imageFolderInput')">選擇資料夾</button>
                <input type="file" id="imageFolderInput" webkitdirectory accept="image/*,.heic,.heif" class="hidden">
            </div>
            <div id="base64FileInput" class="mode-specific" data-mode="base64">
                <label>Base64 檔案</label>
                <button class="file-button" onclick="triggerFileInput('base64Input')">選擇檔案</button>
                <input type="file" id="base64Input" accept=".txt" multiple class="hidden">
            </div>
            <div id="base64FolderInput" class="mode-specific" data-mode="base64">
                <label>Base64 資料夾</label>
                <button class="file-button" onclick="triggerFileInput('base64FolderInput')">選擇資料夾</button>
                <input type="file" id="base64FolderInput" webkitdirectory class="hidden">
            </div>
            <div>
                <label>清空</label>
                <button class="clear-button" onclick="clearFiles()">清空檔案</button>
            </div>
        </div>
        
        <div class="section">
            <h3 id="fileListHeader" style="margin: 0; font-size: 16px; color: #0033A0;">已選擇的檔案：0 張</h3>
            <div id="fileList"></div>
        </div>
        
        <div id="resizeOptions" class="section mode-specific controls" data-mode="resize">
            <div>
                <label>尺寸設定</label>
                <div class="dimension-buttons">
                    <button class="dimension-button active" data-mode="width" onclick="switchDimensionMode('width')">固定寬度</button>
                    <button class="dimension-button" data-mode="height" onclick="switchDimensionMode('height')">固定高度</button>
                    <button class="dimension-button" data-mode="both" onclick="switchDimensionMode('both')">寬度與高度</button>
                </div>
            </div>
            <div id="widthContainer">
                <label>寬度 (px)</label>
                <div class="size-buttons">
                    <button class="size-button" data-value="256" onclick="setSize('width', '256')">256</button>
                    <button class="size-button" data-value="512" onclick="setSize('width', '512')">512</button>
                    <button class="size-button active" data-value="1024" onclick="setSize('width', '1024')">1024</button>
                    <button class="size-button" data-value="1280" onclick="setSize('width', '1280')">1280</button>
                    <button class="size-button" data-value="custom" onclick="setSize('width', 'custom')">自訂</button>
                </div>
                <input type="number" id="widthInput" min="1" class="hidden" placeholder="輸入寬度">
            </div>
            <div id="heightContainer">
                <label>高度 (px)</label>
                <div class="size-buttons">
                    <button class="size-button" data-value="256" onclick="setSize('height', '256')">256</button>
                    <button class="size-button" data-value="512" onclick="setSize('height', '512')">512</button>
                    <button class="size-button active" data-value="1024" onclick="setSize('height', '1024')">1024</button>
                    <button class="size-button" data-value="1280" onclick="setSize('height', '1280')">1280</button>
                    <button class="size-button" data-value="custom" onclick="setSize('height', 'custom')">自訂</button>
                </div>
                <input type="number" id="heightInput" min="1" class="hidden" placeholder="輸入高度">
            </div>
            <div>
                <label>保持比例</label>
                <input type="checkbox" id="aspectRatio" checked onchange="updateDimensions()">
            </div>
            <div id="qualityContainer">
                <label>品質</label>
                <div class="quality-buttons">
                    <button class="quality-button" data-value="0.5" onclick="setQuality('0.5')">50%</button>
                    <button class="quality-button" data-value="0.7" onclick="setQuality('0.7')">70%</button>
                    <button class="quality-button active" data-value="0.9" onclick="setQuality('0.9')">90%</button>
                    <button class="quality-button" data-value="0.95" onclick="setQuality('0.95')">95%</button>
                    <button class="quality-button" data-value="custom" onclick="setQuality('custom')">自訂</button>
                </div>
                <input type="number" id="qualityInput" min="0" max="100" class="hidden" placeholder="0-100">
            </div>
        </div>
        
        <div id="base64Input" class="section mode-specific" data-mode="base64">
            <label>Base64 字串</label>
            <textarea id="base64Text" placeholder="輸入 Base64 字串（例如 data:image/jpeg;base64,...）"></textarea>
        </div>
        
        <div class="section">
            <label>輸出格式</label>
            <div class="format-buttons">
                <button class="format-button active" data-value="image/jpeg" onclick="setFormat('image/jpeg')">JPEG</button>
                <button class="format-button" data-value="image/png" onclick="setFormat('image/png')">PNG</button>
                <button class="format-button" data-value="image/webp" onclick="setFormat('image/webp')">WebP</button>
            </div>
        </div>
        
        <div class="section">
            <div class="file-button-container">
                <button id="resizeButton" class="process-button mode-specific" data-mode="resize" onclick="processResize()">調整尺寸與格式</button>
                <button id="toBase64Button" class="process-button mode-specific" data-mode="base64" onclick="processImageToBase64()">圖片轉 Base64</button>
                <button id="fromBase64Button" class="process-button mode-specific" data-mode="base64" onclick="processBase64ToImage()">Base64 轉圖片</button>
            </div>
        </div>
        
        <div class="section progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">處理中：0/0</div>
        </div>
        
        <div id="errorMessage" class="error-message"></div>
        
        <div class="section">
            <button id="downloadButton">下載結果</button>
        </div>
        
        <div class="section">
            <h3 style="margin: 0; font-size: 16px; color: #0033A0;">縮圖預覽</h3>
            <div id="previewContainer" class="thumbnail-container"></div>
        </div>
        
        <div id="base64Output" class="section mode-specific" data-mode="base64">
            <h3 style="margin: 0; font-size: 16px; color: #0033A0;">Base64 內容</h3>
            <div id="base64OutputContainer"></div>
        </div>
        
        <div class="tooltip">
            <span style="font-size: 12px; color: #005B99;">使用說明</span>
            <span class="tooltip-text">支援圖片尺寸調整、格式轉換（尺寸調整預設 JPEG，Base64 模式預設 PNG，品質 90%）及 Base64 互轉。HEIC/HEIF 支援，多檔案打包為 ZIP。請勿分享敏感 Base64 字串。資料夾選擇僅支援 Chrome、Edge 和 Safari。</span>
        </div>
    </div>

    <script>
        let originalImages = [];
        let processedBlobs = [];
        let base64Data = [];
        let downloadBlob = null;
        let downloadFileName = '';
        let currentDimensionMode = 'width';
        let currentWidthValue = '1024';
        let currentHeightValue = '1024';
        let currentQualityValue = '0.9';
        let currentFormatValue = 'image/jpeg';

        // 檢查瀏覽器是否支援 webkitdirectory
        function checkDirectorySupport() {
            const input = document.createElement('input');
            input.setAttribute('webkitdirectory', '');
            return 'webkitdirectory' in input;
        }

        // 防抖函數
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // 觸發檔案輸入
        function triggerFileInput(inputId) {
            const mode = document.querySelector('.mode-button.active').dataset.mode;
            if (inputId === 'base64FolderInput' && mode !== 'base64') {
                showError('請先切換到「Base64 互轉」模式！');
                return;
            }
            const input = document.getElementById(inputId);
            if (input) {
                if (inputId === 'base64FolderInput' && !checkDirectorySupport()) {
                    showError('此瀏覽器不支援資料夾選擇，請使用 Chrome、Edge 或 Safari！');
                    return;
                }
                console.log(`Triggering file input for: ${inputId}`);
                input.click();
            } else {
                showError(`無法找到輸入元素（${inputId}），請重新載入頁面！`);
            }
        }

        // 初始化模式
        window.onload = function() {
            switchMode('resize');
            if (!checkDirectorySupport()) {
                showError('警告：此瀏覽器不支援資料夾選擇，請使用 Chrome、Edge 或 Safari！');
            }
        };

        // 模式切換
        function switchMode(mode) {
            document.querySelectorAll('.mode-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            document.querySelectorAll('.mode-specific').forEach(el => {
                el.style.display = el.dataset.mode === mode ? 'block' : 'none';
            });
            currentFormatValue = mode === 'resize' ? 'image/jpeg' : 'image/png';
            document.querySelectorAll('.format-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === currentFormatValue);
            });
            toggleQualityContainer();
            clearFiles();
            if (mode === 'resize') {
                switchDimensionMode(currentDimensionMode);
            }
        }

        // 尺寸模式切換
        function switchDimensionMode(mode) {
            currentDimensionMode = mode;
            document.querySelectorAll('.dimension-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            const widthContainer = document.getElementById('widthContainer');
            const heightContainer = document.getElementById('heightContainer');
            widthContainer.classList.toggle('hidden', mode === 'height');
            heightContainer.classList.toggle('hidden', mode === 'width');
            updateDimensionInputs();
            updateFileList();
        }

        // 設置寬度或高度值
        function setSize(type, value) {
            const buttons = document.querySelectorAll(`#${type}Container .size-button`);
            buttons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === value);
            });
            const input = document.getElementById(`${type}Input`);
            input.classList.toggle('hidden', value !== 'custom');
            if (type === 'width') {
                currentWidthValue = value;
            } else {
                currentHeightValue = value;
            }
            updateDimensions();
            updateFileList();
        }

        // 設置品質值
        function setQuality(value) {
            document.querySelectorAll('.quality-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === value);
            });
            const input = document.getElementById('qualityInput');
            input.classList.toggle('hidden', value !== 'custom');
            currentQualityValue = value;
            updateFileList();
        }

        // 設置輸出格式
        function setFormat(value) {
            document.querySelectorAll('.format-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === value);
            });
            currentFormatValue = value;
            toggleQualityContainer();
            updateFileList();
        }

        // 清空檔案
        function clearFiles() {
            originalImages = [];
            processedBlobs = [];
            base64Data = [];
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('previewContainer').innerHTML = '';
            document.getElementById('base64OutputContainer').innerHTML = '';
            document.getElementById('base64Text').value = '';
            document.getElementById('downloadButton').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            currentWidthValue = '1024';
            currentHeightValue = '1024';
            currentQualityValue = '0.9';
            document.querySelectorAll('.size-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === '1024');
            });
            document.querySelectorAll('.quality-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === '0.9');
            });
            document.getElementById('widthInput').classList.add('hidden');
            document.getElementById('heightInput').classList.add('hidden');
            document.getElementById('qualityInput').classList.add('hidden');
            document.querySelectorAll('.format-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === currentFormatValue);
            });
            updateFileList();
        }

        // 顯示錯誤訊息
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // 處理檔案輸入
        document.getElementById('imageInput').addEventListener('change', e => handleFileSelect(e, true, 'image'));
        document.getElementById('imageFolderInput').addEventListener('change', e => handleFileSelect(e, true, 'image'));
        document.getElementById('base64Input').addEventListener('change', e => handleFileSelect(e, true, 'base64'));
        document.getElementById('base64FolderInput').addEventListener('change', e => {
            console.log('base64FolderInput change event triggered'); // 調試日誌
            handleFileSelect(e, true, 'base64');
        });

        // 下載按鈕
        document.getElementById('downloadButton').addEventListener('click', () => {
            if (downloadBlob && downloadFileName) {
                saveAs(downloadBlob, downloadFileName);
            } else {
                showError('無可下載的檔案，請先處理檔案！');
            }
        });

        function handleFileSelect(e, append = false, type = 'image') {
            const files = e.target.files;
            if (!files || files.length === 0) {
                showError('未選擇任何檔案，請重新選擇！');
                return;
            }

            if (!append) {
                clearFiles();
            }

            let validFiles = Array.from(files);
            if (type === 'base64') {
                validFiles = validFiles.filter(file => file.name.toLowerCase().endsWith('.txt'));
                if (validFiles.length === 0) {
                    showError('Base64 資料夾中無 .txt 檔案，請選擇包含 .txt 的資料夾！');
                    return;
                }
            } else if (type === 'image') {
                validFiles = validFiles.filter(file => {
                    const ext = file.name.toLowerCase();
                    return ext.match(/\.(jpeg|jpg|png|heic|heif)$/);
                });
                if (validFiles.length === 0) {
                    showError('圖片資料夾中無支援的圖片檔案（JPEG、PNG、HEIC、HEIF），請重新選擇！');
                    return;
                }
            }

            validFiles.forEach((file, index) => {
                if (originalImages.some(img => img.file.name === file.name && img.file.size === file.size)) {
                    showError(`檔案 ${file.name} 已存在，請選擇其他檔案！`);
                    return;
                }

                if (type === 'image') {
                    const isHeicHeif = file.name.toLowerCase().endsWith('.heic') || file.name.toLowerCase().endsWith('.heif');
                    if (isHeicHeif) {
                        heic2any({ blob: file, toType: 'image/png' })
                            .then(result => {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    handleImageLoad(file, e.target.result, originalImages.length, 'image');
                                };
                                reader.readAsDataURL(result);
                            })
                            .catch(err => {
                                showError(`HEIC/HEIF 轉換失敗 (${file.name})：${err.message}`);
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    handleImageLoad(file, e.target.result, originalImages.length, 'image');
                                };
                                reader.readAsDataURL(file);
                            });
                    } else {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            handleImageLoad(file, e.target.result, originalImages.length, 'image');
                        };
                        reader.readAsDataURL(file);
                    }
                } else if (type === 'base64') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        handleBase64FileLoad(file, e.target.result, originalImages.length);
                    };
                    reader.readAsText(file);
                }
            });
        }

        function handleImageLoad(file, imageSrc, index, type) {
            const img = new Image();
            img.onload = function() {
                originalImages.push({ file, img, type, base64: type === 'image' ? imageSrc : null });
                updateFileList();
                const thumbnail = document.createElement('img');
                thumbnail.src = imageSrc;
                thumbnail.className = 'thumbnail';
                thumbnail.dataset.index = index;
                thumbnail.title = file.name;
                document.getElementById('previewContainer').appendChild(thumbnail);
                if (document.querySelector('.mode-button.active').dataset.mode === 'resize') {
                    updateDimensionInputs();
                }
            };
            img.onerror = function() {
                showError(`無法載入圖片：${file.name}，請確認檔案格式是否為 JPEG、PNG、HEIC 或 HEIF！`);
            };
            img.src = imageSrc;
        }

        async function handleBase64FileLoad(file, text, index) {
            let base64String = text.trim();
            if (!base64String) {
                showError(`Base64 檔案 ${file.name} 內容為空，請檢查檔案！`);
                return;
            }

            const prefixes = [
                'data:image/jpeg;base64,',
                'data:image/png;base64,',
                'data:image/webp;base64,'
            ];

            if (base64String.startsWith('data:image/')) {
                await tryImageLoad(file, base64String, index);
                return;
            }

            for (let prefix of prefixes) {
                const testString = prefix + base64String;
                const isValid = await tryImageLoad(file, testString, index, false);
                if (isValid) {
                    originalImages.push({ file, img: new Image(), type: 'base64', base64: testString });
                    updateFileList();
                    const thumbnail = document.createElement('img');
                    thumbnail.src = testString;
                    thumbnail.className = 'thumbnail';
                    thumbnail.dataset.index = index;
                    thumbnail.title = file.name;
                    document.getElementById('previewContainer').appendChild(thumbnail);
                    return;
                }
            }

            showError(`無法載入 Base64 檔案：${file.name}，請確認內容是否為有效的圖片 Base64 字串！`);
        }

        async function tryImageLoad(file, base64String, index, addToImages = true) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    if (addToImages) {
                        originalImages.push({ file, img, type: 'base64', base64: base64String });
                        updateFileList();
                        const thumbnail = document.createElement('img');
                        thumbnail.src = base64String;
                        thumbnail.className = 'thumbnail';
                        thumbnail.dataset.index = index;
                        thumbnail.title = file.name;
                        document.getElementById('previewContainer').appendChild(thumbnail);
                    }
                    resolve(true);
                };
                img.onerror = function() {
                    resolve(false);
                };
                img.src = base64String;
            });
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            const mode = document.querySelector('.mode-button.active').dataset.mode;
            document.getElementById('fileListHeader').textContent = `已選擇的檔案：${originalImages.length} 張`;

            originalImages.forEach((item, index) => {
                const listItem = document.createElement('div');
                listItem.className = 'file-item';
                let text = `${item.file.name} (${item.type === 'image' ? '圖片' : 'Base64'})`;
                if (mode === 'resize' && item.type === 'image') {
                    const widthInput = parseInt(document.getElementById('widthInput').value) || item.img.width;
                    const heightInput = parseInt(document.getElementById('heightInput').value) || item.img.height;
                    const dimensionMode = currentDimensionMode;
                    const aspectRatio = document.getElementById('aspectRatio').checked;

                    let width = dimensionMode !== 'height' && currentWidthValue === 'custom' ? widthInput : parseInt(currentWidthValue) || item.img.width;
                    let height = dimensionMode !== 'width' && currentHeightValue === 'custom' ? heightInput : parseInt(currentHeightValue) || item.img.height;

                    if (aspectRatio) {
                        const ratio = item.img.height / item.img.width;
                        if (dimensionMode === 'width' && currentWidthValue !== '') {
                            height = Math.round(width * ratio);
                        } else if (dimensionMode === 'height' && currentHeightValue !== '') {
                            width = Math.round(height / ratio);
                        } else if (dimensionMode === 'both' && currentWidthValue !== '' && currentHeightValue !== '') {
                            height = Math.round(width * ratio);
                        }
                    } else if (dimensionMode === 'width') {
                        height = item.img.height;
                    } else if (dimensionMode === 'height') {
                        width = item.img.width;
                    }

                    text += ` | 原尺寸: ${item.img.width}x${item.img.height}`;
                    if (width && height) {
                        text += ` | 調整後: ${width}x${height}`;
                    }
                }
                listItem.textContent = text;
                fileList.appendChild(listItem);
            });
        }

        function toggleQualityContainer() {
            const qualityContainer = document.getElementById('qualityContainer');
            qualityContainer.style.display = currentFormatValue === 'image/png' ? 'none' : 'block';
            updateFileList();
        }

        function updateDimensionInputs() {
            if (!originalImages[0]) return;
            const width = originalImages[0].img.width;
            const height = originalImages[0].img.height;
            const options = ['256', '512', '1024', '1280'];
            currentWidthValue = options.includes(width.toString()) ? width.toString() : '1024';
            currentHeightValue = options.includes(height.toString()) ? height.toString() : '1024';
            document.querySelectorAll('#widthContainer .size-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === currentWidthValue);
            });
            document.querySelectorAll('#heightContainer .size-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === currentHeightValue);
            });
            document.getElementById('widthInput').classList.toggle('hidden', currentWidthValue !== 'custom');
            document.getElementById('heightInput').classList.toggle('hidden', currentHeightValue !== 'custom');
            updateDimensions();
        }

        function updateDimensions() {
            if (!originalImages[0]) return;

            const widthInput = parseInt(document.getElementById('widthInput').value) || 0;
            const heightInput = parseInt(document.getElementById('heightInput').value) || 0;
            const aspectRatio = document.getElementById('aspectRatio').checked;

            let width = currentWidthValue === 'custom' ? (widthInput || originalImages[0].img.width) : parseInt(currentWidthValue);
            let height = currentHeightValue === 'custom' ? (heightInput || originalImages[0].img.height) : parseInt(currentHeightValue);

            if (aspectRatio) {
                const ratio = originalImages[0].img.height / originalImages[0].img.width;
                if (currentDimensionMode === 'width' && width > 0) {
                    currentHeightValue = 'custom';
                    height = Math.round(width * ratio);
                    document.getElementById('heightInput').value = height;
                    document.querySelectorAll('#heightContainer .size-button').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.value === 'custom');
                    });
                    if (!document.getElementById('heightContainer').classList.contains('hidden')) {
                        document.getElementById('heightInput').classList.remove('hidden');
                    }
                } else if (currentDimensionMode === 'height' && height > 0) {
                    currentWidthValue = 'custom';
                    width = Math.round(height / ratio);
                    document.getElementById('widthInput').value = width;
                    document.querySelectorAll('#widthContainer .size-button').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.value === 'custom');
                    });
                    if (!document.getElementById('widthContainer').classList.contains('hidden')) {
                        document.getElementById('widthInput').classList.remove('hidden');
                    }
                } else if (currentDimensionMode === 'both' && width > 0) {
                    currentHeightValue = 'custom';
                    height = Math.round(width * ratio);
                    document.getElementById('heightInput').value = height;
                    document.querySelectorAll('#heightContainer .size-button').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.value === 'custom');
                    });
                    document.getElementById('heightInput').classList.remove('hidden');
                }
            }
            updateFileList();
        }

        // 防抖處理輸入框
        const debouncedUpdateDimensions = debounce(updateDimensions, 300);
        document.getElementById('widthInput').addEventListener('input', debouncedUpdateDimensions);
        document.getElementById('heightInput').addEventListener('input', debouncedUpdateDimensions);
        document.getElementById('qualityInput').addEventListener('input', updateFileList);
        document.getElementById('aspectRatio').addEventListener('change', updateDimensions);

        function updateProgress(current, total) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            progressContainer.style.display = total > 1 ? 'block' : 'none';
            const percentage = (current / total) * 100;
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `處理中：${current}/${total}`;
        }

        async function processResize() {
            if (originalImages.length === 0 || !originalImages.some(item => item.type === 'image')) {
                showError('請先選擇圖片檔案！');
                return;
            }

            const format = currentFormatValue;
            const widthInput = parseInt(document.getElementById('widthInput').value);
            const heightInput = parseInt(document.getElementById('heightInput').value);
            const aspectRatio = document.getElementById('aspectRatio').checked;
            const qualityInput = parseInt(document.getElementById('qualityInput').value);
            const quality = currentQualityValue === 'custom' ? (qualityInput / 100) || 0.9 : parseFloat(currentQualityValue);

            const zip = new JSZip();
            processedBlobs = [];
            document.getElementById('previewContainer').innerHTML = '';
            const totalImages = originalImages.filter(item => item.type === 'image').length;
            let processedCount = 0;

            for (let i = 0; i < originalImages.length; i++) {
                const item = originalImages[i];
                if (item.type !== 'image') continue;

                processedCount++;
                updateProgress(processedCount, totalImages);

                const img = item.img;
                const canvas = document.createElement('canvas');
                let width = currentWidthValue === 'custom' ? (widthInput || img.width) : parseInt(currentWidthValue) || img.width;
                let height = currentHeightValue === 'custom' ? (heightInput || img.height) : parseInt(currentHeightValue) || img.height;

                if (aspectRatio) {
                    const ratio = img.height / img.width;
                    if (currentDimensionMode === 'width' && currentWidthValue !== '') {
                        height = Math.round(width * ratio);
                    } else if (currentDimensionMode === 'height' && currentHeightValue !== '') {
                        width = Math.round(height / ratio);
                    } else if (currentDimensionMode === 'both' && currentWidthValue !== '' && currentHeightValue !== '') {
                        height = Math.round(width * ratio);
                    }
                } else if (currentDimensionMode === 'width') {
                    height = img.height;
                } else if (currentDimensionMode === 'height') {
                    width = img.width;
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                try {
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, format, format === 'image/png' ? 1.0 : quality));
                    const originalName = item.file.name.split('.').slice(0, -1).join('.');
                    const extension = format.split('/')[1];
                    const newFileName = `${originalName}_${width}x${height}.${extension}`;
                    processedBlobs.push({ blob, name: newFileName });

                    if (totalImages > 1) {
                        zip.file(newFileName, blob);
                    }

                    const thumbnail = document.createElement('img');
                    thumbnail.src = URL.createObjectURL(blob);
                    thumbnail.className = 'thumbnail';
                    thumbnail.dataset.index = i;
                    thumbnail.title = newFileName;
                    document.getElementById('previewContainer').appendChild(thumbnail);
                } catch (err) {
                    showError(`處理圖片 ${item.file.name} 失敗：${err.message}`);
                }
            }

            document.getElementById('progressContainer').style.display = 'none';
            const downloadButton = document.getElementById('downloadButton');
            downloadButton.style.display = 'block';

            if (totalImages === 1) {
                downloadBlob = processedBlobs[0].blob;
                downloadFileName = processedBlobs[0].name;
                downloadButton.textContent = '下載處理後的圖片';
            } else {
                try {
                    downloadBlob = await zip.generateAsync({ type: 'blob' });
                    downloadFileName = 'processed_images.zip';
                    downloadButton.textContent = '下載 ZIP 壓縮檔';
                } catch (err) {
                    showError(`生成 ZIP 檔案失敗：${err.message}`);
                }
            }
        }

        async function processImageToBase64() {
            if (originalImages.length === 0 || !originalImages.some(item => item.type === 'image')) {
                showError('請先選擇圖片檔案！');
                return;
            }

            const zip = new JSZip();
            base64Data = [];
            document.getElementById('base64OutputContainer').innerHTML = '';
            const totalImages = originalImages.filter(item => item.type === 'image').length;
            let processedCount = 0;

            for (let i = 0; i < originalImages.length; i++) {
                const item = originalImages[i];
                if (item.type !== 'image') continue;

                processedCount++;
                updateProgress(processedCount, totalImages);

                const canvas = document.createElement('canvas');
                canvas.width = item.img.width;
                canvas.height = item.img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(item.img, 0, 0);

                try {
                    const base64String = canvas.toDataURL(currentFormatValue);
                    base64Data.push({ name: item.file.name, base64: base64String });

                    const outputDiv = document.createElement('div');
                    outputDiv.className = 'file-item';
                    outputDiv.innerHTML = `<strong>${item.file.name}</strong><br><textarea readonly>${base64String}</textarea>`;
                    document.getElementById('base64OutputContainer').appendChild(outputDiv);

                    if (totalImages > 1) {
                        zip.file(`${item.file.name}.txt`, base64String);
                    }
                } catch (err) {
                    showError(`圖片 ${item.file.name} 轉 Base64 失敗：${err.message}`);
                }
            }

            document.getElementById('progressContainer').style.display = 'none';
            const downloadButton = document.getElementById('downloadButton');
            downloadButton.style.display = 'block';

            if (totalImages === 1) {
                const { base64, name } = base64Data[0];
                downloadBlob = new Blob([base64], { type: 'text/plain' });
                downloadFileName = `${name}.txt`;
                downloadButton.textContent = '下載 Base64 檔案';
            } else {
                try {
                    downloadBlob = await zip.generateAsync({ type: 'blob' });
                    downloadFileName = 'base64_files.zip';
                    downloadButton.textContent = '下載 Base64 ZIP 壓縮檔';
                } catch (err) {
                    showError(`生成 Base64 ZIP 檔案失敗：${err.message}`);
                }
            }
        }

        async function processBase64ToImage() {
            let base64String = document.getElementById('base64Text').value.trim();
            const format = currentFormatValue;
            const qualityInput = parseInt(document.getElementById('qualityInput').value);
            const quality = currentQualityValue === 'custom' ? (qualityInput / 100) || 0.9 : parseFloat(currentQualityValue);
            const base64Files = originalImages.filter(item => item.type === 'base64');
            const prefixes = [
                'data:image/jpeg;base64,',
                'data:image/png;base64,',
                'data:image/webp;base64,'
            ];

            if (!base64String && base64Files.length === 0) {
                showError('請輸入 Base64 字串或選擇 Base64 檔案！');
                return;
            }

            const zip = new JSZip();
            processedBlobs = [];
            document.getElementById('previewContainer').innerHTML = '';
            const totalItems = (base64String ? 1 : 0) + base64Files.length;
            let processedCount = 0;

            if (base64String) {
                processedCount++;
                updateProgress(processedCount, totalItems);

                let validBase64 = base64String;
                if (!base64String.startsWith('data:image/')) {
                    for (let prefix of prefixes) {
                        const testString = prefix + base64String;
                        const isValid = await tryImageLoad(null, testString, 0, false);
                        if (isValid) {
                            validBase64 = testString;
                            break;
                        }
                    }
                }

                try {
                    const img = new Image();
                    img.onload = async function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        const blob = await new Promise(resolve => canvas.toBlob(resolve, format, format === 'image/png' ? 1.0 : quality));
                        const fileName = `converted_image_${Date.now()}.${format.split('/')[1]}`;
                        processedBlobs.push({ blob, name: fileName });

                        const thumbnail = document.createElement('img');
                        thumbnail.src = URL.createObjectURL(blob);
                        thumbnail.className = 'thumbnail';
                        thumbnail.title = fileName;
                        document.getElementById('previewContainer').appendChild(thumbnail);

                        if (base64Files.length > 0) {
                            zip.file(fileName, blob);
                        } else {
                            const downloadButton = document.getElementById('downloadButton');
                            downloadButton.style.display = 'block';
                            downloadBlob = blob;
                            downloadFileName = fileName;
                            downloadButton.textContent = '下載轉換後的圖片';
                        }
                        updateProgress(processedCount, totalItems);
                    };
                    img.onerror = function() {
                        showError('無法載入 Base64 字串，請確認是否為有效的圖片 Base64 字串！');
                        updateProgress(processedCount, totalItems);
                    };
                    img.src = validBase64;
                } catch (err) {
                    showError(`Base64 字串轉換失敗：${err.message}`);
                    updateProgress(processedCount, totalItems);
                }
            }

            for (let i = 0; i < base64Files.length; i++) {
                const item = base64Files[i];
                processedCount++;
                updateProgress(processedCount, totalItems);

                try {
                    const img = new Image();
                    img.onload = async function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        const blob = await new Promise(resolve => canvas.toBlob(resolve, format, format === 'image/png' ? 1.0 : quality));
                        const originalName = item.file.name.split('.').slice(0, -1).join('.');
                        const extension = format.split('/')[1];
                        const newFileName = `${originalName}.${extension}`;
                        processedBlobs.push({ blob, name: newFileName });
                        zip.file(newFileName, blob);

                        const thumbnail = document.createElement('img');
                        thumbnail.src = URL.createObjectURL(blob);
                        thumbnail.className = 'thumbnail';
                        thumbnail.dataset.index = originalImages.indexOf(item);
                        thumbnail.title = newFileName;
                        document.getElementById('previewContainer').appendChild(thumbnail);

                        if (processedCount === totalItems) {
                            try {
                                const zipBlob = await zip.generateAsync({ type: 'blob' });
                                const downloadButton = document.getElementById('downloadButton');
                                downloadButton.style.display = 'block';
                                downloadBlob = zipBlob;
                                downloadFileName = 'converted_images.zip';
                                downloadButton.textContent = '下載轉換後的圖片 ZIP 壓縮檔';
                            } catch (err) {
                                showError(`生成 ZIP 檔案失敗：${err.message}`);
                            }
                        }
                        updateProgress(processedCount, totalItems);
                    };
                    img.onerror = function() {
                        showError(`無法載入 Base64 檔案：${item.file.name}，請確認內容是否為有效的圖片 Base64 字串！`);
                        updateProgress(processedCount, totalItems);
                    };
                    img.src = item.base64;
                } catch (err) {
                    showError(`Base64 檔案轉換失敗：${item.file.name}，錯誤：${err.message}`);
                    updateProgress(processedCount, totalItems);
                }
            }

            document.getElementById('progressContainer').style.display = 'none';
        }
    </script>
</body>
</html>
